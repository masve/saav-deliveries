<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="UTF-8">
  <title>Social Data Analysis and Visualization 2016</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  
  <!-- Style sheets -->
  <link rel="stylesheet" href="styles/normalize.css"/>
  <link rel="stylesheet" href="styles/cayman.css"/>
  <link rel="stylesheet" href="styles/styles.css"/>

  <link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css"/>
  
  <!-- Bower components -->
  <script type="text/javascript" src="bower_components/d3/d3.min.js"></script>
  <script type="text/javascript" src="bower_components/lodash/lodash.js"></script>
  <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="bower_components/topojson/topojson.min.js"></script>
  <script type="text/javascript" src="bower_components/leaflet/dist/leaflet.js"></script>

  <!-- CDNs -->
  
  <!-- our scripts --> 
  <script type="text/javascript" src="scripts/knn.js"></script>
  
  <script>
    //Check for ES 6 support, and alert user if his browser does not support it.
    (function(document) {
      "use strict";
      try {
        eval("var foo = (x)=>x+1");
      } catch (e) {
        alert('This page uses modern javascript, that your browser does not support.\nPlease use a modern browser to display this properly (e.i. Chrome or Firefox).')
      }
    })();
  </script>
</head>

<body>
  <span id="browser-sync-binding"></span>

  <section class="page-header">
    <h1 class="project-name">Social Data Analysis and Visualization 2016</h1>
    <h2 class="project-tagline">Use the buttons to navigate the assignments</h2>
    <a href="https://github.com/masve/saav-deliveries" target="_blank" class="btn">View on GitHub</a>
    <a href="/assigment2.html" class="btn">Assignment 2</a>
    <a href="/" class="btn">Project Assignment A &amp; B</a>
  </section>

  <section id="intro" class="main-content">
    <p>
      This page is to represent the work related to assignements for course Social Data Analysis and Visualization.
    </p>
    <p>
      These exercises has been performed by DTU students:
      <ul class="task-list">
        <li><a href="https://www.campusnet.dtu.dk/cnnet/participants/showperson.aspx?id=147236">s113627</a> Casper Clemmensen</li>
        <li><a href="https://www.campusnet.dtu.dk/cnnet/participants/showperson.aspx?id=209126">s146893</a> Kasper Hoa Quoc Duong</li>
        <li><a href="https://www.campusnet.dtu.dk/cnnet/participants/showperson.aspx?id=147192">s113604</a> Mark Ian Svennningsen</li>
      </ul>
    </p>
  </section>


  <section id="project" class="main-content">
    <h1>Project Assignment A</h1>

    <p>Here we have a small introduction video, that shows the idea behind of data analysis.</p>
    <iframe src="http://www.youtube.com/embed/s6K-tIxNXtA" width="100%" height="400px"></iframe>

  </section>


  <section class="main-content">
    <h2>Find your local intersection</h2>
    <p>In NYC there is a lot of collistions thougth the city. Therefore we are providing an opportunity for you to discover
      the amount of collistions, injuries and fatalaties in intersections thougth the city. Locate the intersection nearest
      to your home, work or on your daily commute.</p>
    <p>Note that the size of the points indicate the amount of collisions, as the <span style="color:red">red</span> color show
      if there is any fatalities.</p>
    <div class="map" id="intersections"></div>
    <p class="small">Note that all intersections with less that 10 collisions and without falaties have been omitted to increase performance.</p>
    <script>
      (function(d) {
          "use strict";
          
          class Intersection {
            constructor(target) {
              this.maxZoomLevel = 18;
              this.zoomLevel = 12;
              this.accessToken = 'pk.eyJ1IjoiY2xlbW1lIiwiYSI6ImNpbjdhNGR4MTAwMW11c2x6aGlsZXJ2dHoifQ.zKSRPItYOGDGxSUuXr_McQ';
              this.projectionId = 'clemme.pngigh8e';
              this.intersections = [];
              this.scale = d3.scale.linear();
              this.pointOptions = {
                stroke: true,
                color: '#03f',
                clickable: true,
                weight: 2
              };
              this.lowerBound = 10;
              
              this.map = L.map(target).setView([40.715, -73.984], 11);
              
              this.map.on('zoomend', (e) => this.zoomChanged(e))
              
              this.addMapLayer();
              this.loadInterSection();
            }
            zoomChanged(e) {
              this.zoomLevel = e.target._zoom;
            }
            addMapLayer() {
              // Add the map layer to the map (if omitted the map will only be gray box)
              L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
                maxZoom: this.maxZoomLevel,
                id: this.projectionId,
                accessToken: this.accessToken
              }).addTo(this.map);
              
            }
            loadInterSection() {
              d3.csv(
                'datasets/collision_counts.csv',
                row => {
                   return {
                    'LOCATION': +row['LOCATION'],
                    'NUMBER OF PERSONS KILLED': +row['NUMBER OF PERSONS KILLED'],
                    'NUMBER OF PERSONS INJURED': +row['NUMBER OF PERSONS INJURED'],
                    'LAT': row['LAT'],
                    'LON': row['LON'].trim()
                  };
                },
                (err, json) => {
                  if (err) {
                    console.log(err);
                  }
                  this.intersections = json; 
                  this.scale = this.scale.domain([
                    d3.min(json, j => j.LOCATION),
                    d3.max(json, j => j.LOCATION),
                  ]).range([10, 120]);
                  this.addPoint();
              })
            }
            addPoint() {
              if (this.intersections.length > 0) {  
                this.intersections.forEach( a => {
                  if (a.LOCATION > this.lowerBound || a['NUMBER OF PERSONS KILLED'] > 0 ) {
                    // Add a circle for the given intersection. Adjust the radio with regards to the amount of incidents.
                    L
                      .circle([a.LAT, a.LON], this.scale(a.LOCATION), {
                          color: parseInt(a['NUMBER OF PERSONS KILLED']) >= 1 ? '#F11': '#03f',
                          clickable: true,
                          weight: 2
                      })
                      .bindPopup(`Total collisions: ${a.LOCATION} <br/> Injuries ${a['NUMBER OF PERSONS INJURED']}<br/> Fatalities ${a['NUMBER OF PERSONS KILLED']}`)
                      .addTo(this.map);
                  }
                });
                
              }
              
            }
          }
          
          document.addEventListener('DOMContentLoaded', new Intersection('intersections'));
        })();
    </script>

    </section>
    
    <section class="main-content">
      
      <h2>A Closer Look</h2>
      <p>Let's take a closer look at the intersections. Are there any intersections that are different from the rest? And are there an underlying reason for this?</p>
      
      <p>Let's begin by locating the top 10 intersections with the most collisions. </p>
      
      <svg id="top10intersections" class="center" style="display:block; width:100%"></svg>
      <div id="top10intersectionstooltip" class="hidden tooltip" style="width:400px">
          <p><strong><span id="title">Title</span></strong></p>
          <p>Location:&nbsp;<span id="location">100</span></p>
          <p>Collisions:&nbsp;<span id="col"></span></p>
          <p><i>Click to view</i></p>
      </div>
      
      <script>
        'use strict';
        
        class Top10 {
          constructor(svg) {
            this.svg = d3.select(svg);
            this.cvsPath = 'datasets/pb/intersection_top_10.csv';
            this.xScale = d3.scale.ordinal();
            this.yScale = d3.scale.linear();
            svg.style.width = "100%";
            this.paddingLeft = (svg.clientWidth / 5);
            this.paddingTop = 30;
            this.height = 330;
            this.width = svg.clientWidth;
            this.bars = this.svg.append('g');
            this.yAxis = this.svg.append('g');
            this.xAxis = this.svg.append('g');
            this.xLabels = [];
            this.tooltip = d3.select('#top10intersectionstooltip')
            
            this.data = null;
            
            svg.style.height = this.height + 300;
            svg.style['padding-left'] = this.paddingLeft;
            
            d3.csv(
              this.cvsPath,
              (r) => ({collisions: +r['COLLISIONS'], name: `${r['ON STREET NAME']} / ${r['CROSS STREET NAME']}`, location: r['LOCATION']}),
              this.onDataLoaded.bind(this)
            );
          }
          onDataLoaded(data) {
            this.data = data;
            // X scale
            this.xScale = this.xScale.domain(d3.range(data.length))
              .rangeRoundBands([0, 300], 0.05);

            // Y scale
            this.yScale = this.yScale
              .domain([0, d3.max(this.data, d => d.collisions)])
              .range([0, this.width - (2*this.paddingLeft) - 20]);
            
            this.xLabels = data.map(d => d.name);
              
            this.render();
          }
          render() {
            
            const max = d3.max(this.data, d => d.collisions);
            
            this.bars
                .selectAll('rect')
                .data(this.data)
                .enter()
                .append('rect')
                .attr({
                  'x': (d, i) => (this.paddingLeft),
                  'height': this.xScale.rangeBand(),
                  'fill': 'cornflowerblue',
                  'y': (d,i) => (this.xScale(i) + this.paddingTop),
                  'width': 0
                })
                .on('mouseover', this.renderTooltip.bind(this))
                .on('mouseout', this.hideTooltip.bind(this))
                .on('click', this.sendToMaps.bind(this))
                .transition()
                .duration(2000) 
                .delay((d, i) => (i / this.data.length * 1000) + 10000)
                .attr({
                  'width': d => (Math.abs(this.yScale(0) - this.yScale(d.collisions)))
                })
                
                
            this.renderAxis();
          }
          renderTooltip(aCollision) {
            
            this.tooltip
            .classed('hidden', false)
            .transition()
            .style('left', `${d3.event.pageX}px`)
            .style('top', `${d3.event.pageY}px`)
            .style('opacity', 1)
            .duration(100);

            this.tooltip.select('#title').text(aCollision.name);
            this.tooltip.select('#col').text(aCollision.collisions);
            this.tooltip.select("#location").text(aCollision.location);
          }
          hideTooltip() {
            this.tooltip
                .transition()
                .duration(150)
                .style('opacity', 0);            
          }
          renderAxis() {
            // Define axes
            
            let xAxis = d3.svg.axis().scale(this.xScale).orient('left').tickFormat((d) => this.xLabels[d]).tickValues(d3.range(10));
            let yAxis = d3.svg.axis().scale(this.yScale).orient('bottom').ticks(11);
            
            // Add y axis to histogram
            this.xAxis.attr({
              'class': 'axis',
              'transform': `translate(${this.paddingLeft}, ${this.paddingTop})`
            }).call(xAxis);
            
            this.yAxis.attr({
              'class': 'axis',
              'transform': `translate(${this.paddingLeft}, ${this.height})`
            })
            .call(yAxis)
            .selectAll("text")  
            .style("text-anchor", "end")
            .attr({
             'dx': '.8em'
            });
            
          }
          sendToMaps(aCollision) {
            const [lat, lon] = _.trim(aCollision.location, ['(', ')']).split(',');
            const url = `http://maps.google.com/maps?z=12&t=h&q=loc:${lat.trim()}+${lon.trim()}`
            window.open(url, '_blank').focus();
          }
        }
        
        
        
        
        document.addEventListener("DOMContentLoaded", new Top10(document.querySelector('svg#top10intersections')));
      </script>
      
    </section>
    
    <section class="main-content">
      <h2>Distribution By Postal District</h2>
      <svg id="projectMap"></svg>
      <div id="tooltip" class="hidden tooltip">
          <p><strong>Zip code:&nbsp; <span id="title">Title</span></strong></p>
          <p>Name:&nbsp;<span id="value">100</span></p>
          <p>Population:&nbsp;<span id="pop"></span></p>
          <p>Collisions:&nbsp;<span id="col"></span></p>
      </div>
      <button id="toggle" data-toggle="pop" class="btn btncolor toggle" style="width:25%" disabled>VIEW COLLISIONS</button>
    <script>
      (function(doo) {
          'use strict';

          document.addEventListener("DOMContentLoaded", new KNN(document.querySelector('svg#projectMap'), document.querySelector('button#toggle')));
        })();
    </script>

  </section>

  </section>

  <section id="info" class="main-content">
    <footer class="site-footer">
      <span class="site-footer-owner">For DTU course <a href="http://www.kurser.dtu.dk/courses/02806/default.aspx?menulanguage=en-GB">Social Data Analysis and Visualization</a> in relation to assignments described by <a href="https://github.com/suneman/socialdataanalysis2016/wiki/Assignments">suneman</a>.</span>
      <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
    </footer>
  </section>
  <script>
    $(function() {
      $('a[href*="#"]:not([href="#"])').click(function() {
        if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
          if (target.length) {
            $('html, body').animate({
              scrollTop: target.offset().top
            }, 1000);
            return false;
          }
        }
      });
    });
  </script>
</body>

</html>